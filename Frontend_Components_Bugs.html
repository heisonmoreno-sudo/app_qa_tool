<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
     FRONTEND_COMPONENTS_BUGS.HTML
     Componente para gesti√≥n de bugs
     Actualizado: feature/bugs-trello
     ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

<style>
    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */
    /* ESTILOS DE BUGS                                          */
    /* ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê */

    .bugs-container {
        max-width: 1400px;
        margin: 0 auto;
    }

    /* Badges de severidad */
    .badge-severidad-critica {
        background: #fee2e2;
        color: #991b1b;
        font-weight: 700;
    }

    .badge-severidad-alta {
        background: #fed7aa;
        color: #9a3412;
        font-weight: 600;
    }

    .badge-severidad-media {
        background: #fef3c7;
        color: #92400e;
        font-weight: 600;
    }

    .badge-severidad-baja {
        background: #dbeafe;
        color: #1e40af;
        font-weight: 600;
    }

    /* Badges de estado bug */
    .badge-bug-abierto {
        background: #fee2e2;
        color: #991b1b;
        border: 2px solid #fca5a5;
    }

    .badge-bug-cerrado {
        background: #d1fae5;
        color: #065f46;
        border: 2px solid #6ee7b7;
    }
</style>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- MODAL CREAR/EDITAR BUG                                                      -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

<div id="modalCrearBug" class="modal-overlay">
    <div
        class="modal"
        style="max-width: 800px; max-height: 90vh; overflow-y: auto"
    >
        <div class="modal-header">
            <h3 class="modal-title">
                <span>üêõ</span>
                <span id="tituloModalBug">Reportar Bug</span>
            </h3>
            <button class="modal-close" onclick="cerrarModalBug()">‚úï</button>
        </div>

        <div class="modal-body">
            <!-- Info del caso relacionado (si aplica) -->
            <div
                id="infoCasoRelacionado"
                class="hidden"
                style="
                    background: #eff6ff;
                    border: 2px solid #3b82f6;
                    border-radius: 8px;
                    padding: 1rem;
                    margin-bottom: 1.5rem;
                "
            >
                <div style="display: flex; align-items: start; gap: 0.75rem">
                    <span style="font-size: 1.5rem">üîó</span>
                    <div style="flex: 1">
                        <strong
                            style="
                                color: #1e40af;
                                display: block;
                                margin-bottom: 0.25rem;
                            "
                        >
                            Bug relacionado con caso de prueba
                        </strong>
                        <div style="color: #1e40af; font-size: 0.9rem">
                            <strong id="casoRelacionadoId"></strong> -
                            <span id="casoRelacionadoTitulo"></span>
                        </div>
                    </div>
                </div>
            </div>

            <form id="formCrearBug" onsubmit="guardarBug(); return false;">
                <input type="hidden" id="bugCasoRelacionado" value="" />
                <input type="hidden" id="bugModoEdicion" value="false" />
                <input type="hidden" id="bugIdEdicion" value="" />

                <!-- CAMPOS OBLIGATORIOS -->
                <div class="form-group">
                    <label class="form-label required"
                        >üêõ T√≠tulo del Bug (10-100 caracteres)</label
                    >
                    <input
                        type="text"
                        id="bugTitulo"
                        class="form-input"
                        required
                        minlength="10"
                        maxlength="100"
                        placeholder="Ej: Error en validaci√≥n de email en formulario de registro"
                    />
                </div>

                <div class="form-group">
                    <label class="form-label required"
                        >üìù Descripci√≥n (m√≠n. 10 caracteres)</label
                    >
                    <textarea
                        id="bugDescripcion"
                        class="form-textarea"
                        required
                        minlength="10"
                        rows="3"
                        placeholder="Describe el bug de forma clara y concisa..."
                    ></textarea>
                </div>

                <div
                    style="
                        display: grid;
                        grid-template-columns: 1fr 1fr;
                        gap: 1rem;
                    "
                >
                    <div class="form-group">
                        <label class="form-label required">üî¥ Severidad</label>
                        <select id="bugSeveridad" class="form-select" required>
                            <option value="Cr√≠tica">üî¥ Cr√≠tica</option>
                            <option value="Alta">üü† Alta</option>
                            <option value="Media" selected>üü° Media</option>
                            <option value="Baja">üü¢ Baja</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label class="form-label required">‚ö° Prioridad</label>
                        <select id="bugPrioridad" class="form-select" required>
                            <option value="Alta">‚ö° Alta</option>
                            <option value="Media" selected>üî∏ Media</option>
                            <option value="Baja">üîπ Baja</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label required">üìã Precondiciones</label>
                    <textarea
                        id="bugPrecondiciones"
                        class="form-textarea"
                        required
                        minlength="10"
                        rows="2"
                        placeholder="Ej: Usuario debe estar logueado como administrador"
                    ></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label required"
                        >üî¢ Datos de Prueba</label
                    >
                    <textarea
                        id="bugDatosPrueba"
                        class="form-textarea"
                        required
                        minlength="10"
                        rows="2"
                        placeholder="Ej: Email: test@test.com, Password: Test123!"
                    ></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label required"
                        >üë£ Pasos para Reproducir</label
                    >
                    <textarea
                        id="bugPasosReproducir"
                        class="form-textarea"
                        required
                        minlength="10"
                        rows="4"
                        placeholder="1. Ir a la p√°gina de login&#10;2. Ingresar email inv√°lido&#10;3. Click en 'Iniciar Sesi√≥n'&#10;4. Observar el error"
                    ></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label required"
                        >‚úÖ Resultado Esperado</label
                    >
                    <textarea
                        id="bugResultadoEsperado"
                        class="form-textarea"
                        required
                        minlength="10"
                        rows="2"
                        placeholder="Ej: Debe mostrar mensaje 'Email inv√°lido'"
                    ></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label required"
                        >‚ùå Resultado Obtenido</label
                    >
                    <textarea
                        id="bugResultadoObtenido"
                        class="form-textarea"
                        required
                        minlength="10"
                        rows="2"
                        placeholder="Ej: Muestra error 500 y la aplicaci√≥n se cuelga"
                    ></textarea>
                </div>

                <!-- CAMPOS OPCIONALES -->
                <div
                    style="
                        border-top: 2px dashed #e2e8f0;
                        margin: 1.5rem 0;
                        padding-top: 1.5rem;
                    "
                >
                    <h4
                        style="
                            font-size: 1rem;
                            font-weight: 600;
                            color: #475569;
                            margin-bottom: 1rem;
                        "
                    >
                        üìå Informaci√≥n Adicional (Opcional)
                    </h4>

                    <div
                        style="
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 1rem;
                        "
                    >
                        <div class="form-group">
                            <label class="form-label">üåê Ambiente</label>
                            <select id="bugAmbiente" class="form-select">
                                <option value="">Seleccionar...</option>
                                <option value="Producci√≥n">Producci√≥n</option>
                                <option value="Staging">Staging</option>
                                <option value="QA">QA</option>
                                <option value="Dev">Dev</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label class="form-label">üåê Navegador</label>
                            <select id="bugNavegador" class="form-select">
                                <option value="">Seleccionar...</option>
                                <option value="Chrome">Chrome</option>
                                <option value="Firefox">Firefox</option>
                                <option value="Safari">Safari</option>
                                <option value="Edge">Edge</option>
                                <option value="Otro">Otro</option>
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label"
                            >üè∑Ô∏è Etiquetas (separadas por coma)</label
                        >
                        <input
                            type="text"
                            id="bugEtiquetas"
                            class="form-input"
                            placeholder="Ej: login, validaci√≥n, frontend"
                        />
                        <p class="form-help">
                            Las etiquetas se usar√°n en Trello
                        </p>
                    </div>

                    <div class="form-group">
                        <label class="form-label">üìù Notas</label>
                        <textarea
                            id="bugNotas"
                            class="form-textarea"
                            rows="2"
                            placeholder="Informaci√≥n adicional, comentarios, etc."
                        ></textarea>
                    </div>
                </div>

                <!-- EVIDENCIAS -->
                <div class="form-group">
                    <label class="form-label">üìé Evidencias</label>

                    <div
                        style="
                            background: #eff6ff;
                            border: 1px solid #3b82f6;
                            border-radius: 6px;
                            padding: 0.75rem;
                            margin-bottom: 1rem;
                            display: flex;
                            align-items: start;
                            gap: 0.5rem;
                        "
                    >
                        <span style="font-size: 1.25rem">üí°</span>
                        <div style="flex: 1; font-size: 0.9rem; color: #1e40af">
                            <strong>Importante:</strong> Los archivos se subir√°n
                            a Drive cuando guardes el bug.
                        </div>
                    </div>

                    <!-- Zona de archivos -->
                    <div style="margin-bottom: 1rem">
                        <div style="font-weight: 600; margin-bottom: 0.5rem">
                            üì§ Subir archivos (m√°x 50MB c/u)
                        </div>
                        <div
                            id="dropzoneBug"
                            class="dropzone-evidencias"
                            ondrop="handleDropBug(event)"
                            ondragover="handleDragOverBug(event)"
                            ondragleave="handleDragLeaveBug(event)"
                            style="cursor: pointer"
                        >
                            <div style="text-align: center; padding: 2rem">
                                <div
                                    style="
                                        font-size: 3rem;
                                        margin-bottom: 0.5rem;
                                    "
                                >
                                    üìÅ
                                </div>
                                <div
                                    style="
                                        font-weight: 600;
                                        margin-bottom: 0.25rem;
                                    "
                                >
                                    Arrastra archivos aqu√≠ o haz click
                                </div>
                                <div
                                    style="
                                        font-size: 0.85rem;
                                        color: #64748b;
                                        line-height: 1.6;
                                    "
                                >
                                    üñºÔ∏è Im√°genes: m√°x 10MB<br />
                                    üé• Videos: m√°x 100MB<br />
                                    üìÑ PDFs: m√°x 20MB
                                </div>
                            </div>
                        </div>
                        <input
                            type="file"
                            id="inputArchivosBug"
                            multiple
                            accept="image/*,video/*,.pdf"
                            style="display: none"
                            onchange="handleFileSelectBug(event)"
                        />
                    </div>

                    <!-- Lista de evidencias -->
                    <div
                        id="listaEvidenciasBug"
                        class="lista-evidencias hidden"
                    >
                        <div style="font-weight: 600; margin-bottom: 0.5rem">
                            üìã Archivos agregados:
                        </div>
                        <div id="contenidoListaEvidenciasBug"></div>
                    </div>
                </div>
            </form>
        </div>

        <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
        <!-- OPCIONES TRELLO DENTRO DEL MODAL (compacto)                       -->
        <!-- ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ -->
        <div
            id="trelloBugOptions"
            style="
                margin-top: 2rem;
                background-color: #f0f9ff;
                border: 2px solid #0ea5e9;
                border-radius: 8px;
                padding: 1rem;
            "
        >
            <!-- Encabezado con logo -->
            <div
                style="
                    display: flex;
                    align-items: center;
                    gap: 1rem;
                    margin-bottom: 1rem;
                "
            >
                <span style="font-size: 2rem">üé´</span>
                <div>
                    <h4
                        style="
                            font-size: 1.1rem;
                            font-weight: 600;
                            color: #0369a1;
                            margin: 0;
                        "
                    >
                        Integraci√≥n con Trello
                    </h4>
                    <p
                        style="
                            font-size: 0.9rem;
                            color: #0369a1;
                            margin: 0.25rem 0 0 0;
                        "
                    >
                        Enviar este bug a una tarjeta de Trello autom√°ticamente
                    </p>
                </div>
            </div>

            <!-- Toggle principal -->
            <label
                style="
                    display: flex;
                    align-items: center;
                    gap: 0.75rem;
                    font-weight: 600;
                    color: #0c4a6e;
                    margin-bottom: 1rem;
                    padding: 0.5rem;
                    background: rgba(255, 255, 255, 0.5);
                    border-radius: 6px;
                    cursor: pointer;
                "
            >
                <input
                    type="checkbox"
                    id="bugEnviarATrello"
                    checked
                    style="width: 1.2rem; height: 1.2rem"
                />
                <span style="font-size: 1.05rem">
                    <span class="hide-mobile">üéØ </span>
                    Crear tarjeta en Trello
                </span>
            </label>

            <div
                id="trelloBugConfigured"
                class="hidden"
                style="margin-top: 0.75rem"
            >
                <div class="form-group" style="margin-bottom: 0.75rem">
                    <label class="form-label required" style="color: #0c4a6e">
                        <span class="hide-mobile">üìã </span>Tablero de Trello
                    </label>
                    <select
                        id="bugBoardSelect"
                        class="form-select"
                        onchange="cargarListasModalPorBoard()"
                        style="border-color: #0ea5e9"
                    >
                        <option value="">Cargando tableros...</option>
                    </select>
                </div>

                <div class="form-group" style="margin-bottom: 1rem">
                    <label class="form-label" style="color: #0c4a6e">
                        <span class="hide-mobile">üìë </span>Lista destino
                        (override)
                    </label>
                    <select
                        id="bugListSelect"
                        class="form-select"
                        style="border-color: #0ea5e9"
                    >
                        <option value="">Selecciona un tablero primero</option>
                    </select>
                </div>

                <div style="font-size: 0.9rem; display: flex; gap: 1rem">
                    <a
                        href="#"
                        onclick="abrirConfiguracionTrelloInline(); return false;"
                        style="
                            color: #0369a1;
                            display: flex;
                            align-items: center;
                            gap: 0.5rem;
                        "
                    >
                        <span>‚öôÔ∏è</span>
                        <span>Cambiar configuraci√≥n</span>
                    </a>
                    <a
                        href="https://trello.com/app-key"
                        target="_blank"
                        rel="noopener noreferrer"
                        style="
                            color: #0369a1;
                            display: flex;
                            align-items: center;
                            gap: 0.5rem;
                        "
                    >
                        <span>üîë</span>
                        <span>Obtener API Key</span>
                    </a>
                    <a
                        href="https://trello.com/1/authorize?expiration=never&name=QA-Tool&scope=read,write&response_type=token"
                        target="_blank"
                        rel="noopener noreferrer"
                        style="
                            color: #0369a1;
                            display: flex;
                            align-items: center;
                            gap: 0.5rem;
                        "
                    >
                        <span>üîê</span>
                        <span>Generar Token</span>
                    </a>
                </div>
            </div>

            <div
                id="trelloBugNotConfigured"
                style="margin-top: 0.75rem; display: none"
            >
                <div
                    style="
                        color: #0369a1;
                        margin-bottom: 1rem;
                        font-size: 0.95rem;
                    "
                >
                    <p style="margin: 0 0 0.5rem 0">
                        ‚ö° Para empezar a enviar bugs a Trello necesitas:
                    </p>
                    <ol style="margin: 0 0 0 1.5rem; padding: 0">
                        <li style="margin-bottom: 0.25rem">
                            <a
                                href="https://trello.com/app-key"
                                target="_blank"
                                style="color: #0369a1; font-weight: 500"
                                >Obtener API Key</a
                            >
                        </li>
                        <li style="margin-bottom: 0.25rem">
                            <a
                                href="https://trello.com/1/authorize?expiration=never&name=QA-Tool&scope=read,write&response_type=token"
                                target="_blank"
                                rel="noopener noreferrer"
                                style="color: #0369a1; font-weight: 500"
                                >Generar Token</a
                            >
                        </li>
                        <li>Configurar las credenciales en la herramienta</li>
                    </ol>
                </div>

                <button
                    type="button"
                    class="btn btn-primary"
                    onclick="abrirConfiguracionTrelloInline()"
                    style="
                        background: #0ea5e9;
                        border-color: #0ea5e9;
                        font-weight: 600;
                        display: flex;
                        align-items: center;
                        gap: 0.5rem;
                    "
                >
                    <span>‚öôÔ∏è</span>
                    <span>Configurar Integraci√≥n</span>
                </button>
            </div>

            <!-- Inline config dentro del modal (oculto por defecto) -->
            <div
                id="trelloInlineConfig"
                style="display: none; margin-top: 1rem"
            >
                <div
                    style="
                        background: white;
                        border: 1px solid #cfeefe;
                        padding: 0.75rem;
                        border-radius: 6px;
                    "
                >
                    <div
                        style="
                            display: flex;
                            gap: 0.5rem;
                            align-items: center;
                            margin-bottom: 0.5rem;
                        "
                    >
                        <strong style="color: #0c4a6e"
                            >‚öôÔ∏è Configurar Trello (r√°pido)</strong
                        >
                        <div
                            style="
                                font-size: 0.85rem;
                                color: #64748b;
                                margin-left: auto;
                            "
                        >
                            Coloca tu API Key y Token
                        </div>
                    </div>

                    <div
                        style="
                            display: grid;
                            grid-template-columns: 1fr 1fr;
                            gap: 0.5rem;
                            margin-bottom: 0.5rem;
                        "
                    >
                        <div>
                            <label class="form-label">API Key</label>
                            <input
                                id="trelloApiKeyInline"
                                class="form-input"
                                placeholder="32 chars"
                            />
                        </div>
                        <div>
                            <label class="form-label">Token</label>
                            <input
                                id="trelloTokenInline"
                                class="form-input"
                                placeholder="64 chars"
                            />
                            <div style="margin-top: 0.25rem">
                                <a
                                    href="#"
                                    id="trelloTokenLink"
                                    target="_blank"
                                    rel="noopener"
                                    style="font-size: 0.85rem; color: #2563eb"
                                >
                                    Generar token
                                </a>
                                <span
                                    style="font-size: 0.85rem; color: #64748b"
                                >
                                    ‚Ä¢ Pega el token aqu√≠</span
                                >
                            </div>
                        </div>
                    </div>

                    <div
                        id="trelloBoardListStepInline"
                        style="display: none; margin-bottom: 0.5rem"
                    >
                        <label class="form-label">Tablero</label>
                        <select
                            id="trelloBoardSelectInline"
                            class="form-select"
                            onchange="cargarListasTrelloInline()"
                        >
                            <option value="">Selecciona un tablero</option>
                        </select>

                        <label class="form-label" style="margin-top: 0.5rem"
                            >Lista</label
                        >
                        <select id="trelloListSelectInline" class="form-select">
                            <option value="">Selecciona una lista</option>
                        </select>
                    </div>

                    <div
                        style="
                            display: flex;
                            gap: 0.5rem;
                            justify-content: flex-end;
                        "
                    >
                        <button
                            type="button"
                            class="btn btn-secondary"
                            onclick="cerrarConfiguracionTrelloInline()"
                        >
                            Cancelar
                        </button>
                        <button
                            id="btnValidarCredencialesInline"
                            type="button"
                            class="btn btn-secondary"
                            onclick="validarCredencialesTrelloInline()"
                        >
                            üîê Validar
                        </button>
                        <button
                            id="btnGuardarConfigTrelloInline"
                            type="button"
                            class="btn btn-primary"
                            onclick="guardarConfiguracionTrelloInline()"
                            style="display: none"
                        >
                            üíæ Guardar
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="modal-footer">
            <button
                type="button"
                class="btn btn-primary"
                onclick="guardarBug(); return false;"
            >
                üíæ Crear Bug
            </button>
            <button
                type="button"
                class="btn btn-secondary"
                onclick="cerrarModalBug()"
            >
                Cancelar
            </button>
        </div>
    </div>
</div>

<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->
<!-- MODAL CAMBIAR ESTADO BUG (MEJORA 5)                                         -->
<!-- ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê -->

<div id="modalCambiarEstadoBug" class="modal-overlay">
    <div class="modal" style="max-width: 600px">
        <div class="modal-header">
            <h3 class="modal-title">
                <span>üîÑ</span>
                <span>Cambiar Estado del Bug</span>
            </h3>
            <button class="modal-close" onclick="cerrarModalCambiarEstado()">
                ‚úï
            </button>
        </div>

        <div class="modal-body">
            <input type="hidden" id="bugIdCambiarEstado" value="" />
            <input type="hidden" id="nuevoEstadoBug" value="" />

            <!-- Advertencia de casos asociados -->
            <div
                id="advertenciaCasosNoOK"
                class="hidden"
                style="
                    background: #fef3c7;
                    border: 2px solid #f59e0b;
                    border-radius: 8px;
                    padding: 1rem;
                    margin-bottom: 1.5rem;
                "
            >
                <div style="display: flex; align-items: start; gap: 0.75rem">
                    <span style="font-size: 2rem">‚ö†Ô∏è</span>
                    <div style="flex: 1">
                        <strong
                            style="
                                color: #92400e;
                                display: block;
                                margin-bottom: 0.5rem;
                            "
                        >
                            Casos de prueba relacionados en estado No_OK
                        </strong>
                        <p style="color: #92400e; margin: 0.5rem 0">
                            Este bug tiene casos de prueba asociados que est√°n
                            en estado <strong>No_OK</strong>:
                        </p>
                        <ul
                            id="listaCasosNoOK"
                            style="
                                color: #92400e;
                                margin: 0.5rem 0 0 1.5rem;
                                line-height: 1.6;
                            "
                        ></ul>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label"
                    >¬øDeseas actualizar autom√°ticamente estos casos a
                    <strong>OK</strong>?</label
                >
                <p
                    style="
                        color: var(--text-secondary);
                        font-size: 0.9rem;
                        margin: 0.5rem 0;
                    "
                >
                    Si el bug est√° resuelto, los casos relacionados pueden pasar
                    a estado OK autom√°ticamente.
                </p>
            </div>

            <div class="form-group">
                <label
                    style="
                        display: flex;
                        align-items: center;
                        gap: 0.5rem;
                        cursor: pointer;
                    "
                >
                    <input type="checkbox" id="actualizarCasosCheck" checked />
                    <span>S√≠, actualizar casos de No_OK a OK</span>
                </label>
            </div>
        </div>

        <div class="modal-footer">
            <button
                type="button"
                class="btn btn-primary"
                onclick="confirmarCambioEstadoBug()"
            >
                ‚úÖ Confirmar Cambio
            </button>
            <button
                type="button"
                class="btn btn-secondary"
                onclick="cerrarModalCambiarEstado()"
            >
                Cancelar
            </button>
        </div>
    </div>
</div>

<script>
    // ===================================================================
    // VARIABLES GLOBALES DE BUGS
    // ===================================================================

    (function () {
        console.log("üîµ Iniciando carga de Frontend_Components_Bugs.html");

        if (!window.evidenciasBugTemporales)
            window.evidenciasBugTemporales = [];
        if (!window.bugEnEdicion) window.bugEnEdicion = null;
        console.log("‚úÖ Variables globales de Bugs inicializadas");
    })();

    // ===================================================================
    // ABRIR MODAL CREAR BUG
    // ===================================================================

    window.abrirModalCrearBug = function abrirModalCrearBug(casoId) {
        console.log("üêõ Abriendo modal crear bug...");
        console.log("   Caso relacionado:", casoId || "Ninguno (bug manual)");

        console.log("üîç Verificando elementos del DOM para el modal...");

        // Validar elementos cr√≠ticos
        const elementosRequeridos = {
            modal: document.getElementById("modalCrearBug"),
            titulo: document.getElementById("tituloModalBug"),
            infoCaso: document.getElementById("infoCasoRelacionado"),
        };

        // Verificar elementos faltantes
        const elementosFaltantes = Object.entries(elementosRequeridos)
            .filter(([_, element]) => !element)
            .map(([name, _]) => name);

        if (elementosFaltantes.length > 0) {
            console.error(
                "‚ùå Elementos no encontrados:",
                elementosFaltantes.join(", ")
            );
            mostrarToast(
                "Error: Modal de bugs no disponible - Faltan elementos",
                "error"
            );
            return;
        }

        const { modal, titulo, infoCaso } = elementosRequeridos;

        // Limpiar campos manualmente (sin usar form.reset)
        document.getElementById("bugTitulo").value = "";
        document.getElementById("bugDescripcion").value = "";
        document.getElementById("bugSeveridad").value = "Media";
        document.getElementById("bugPrioridad").value = "Media";
        document.getElementById("bugPrecondiciones").value = "";
        document.getElementById("bugDatosPrueba").value = "";
        document.getElementById("bugPasosReproducir").value = "";
        document.getElementById("bugResultadoEsperado").value = "";
        document.getElementById("bugResultadoObtenido").value = "";
        document.getElementById("bugAmbiente").value = "";
        document.getElementById("bugNavegador").value = "";
        document.getElementById("bugEtiquetas").value = "";
        document.getElementById("bugNotas").value = "";

        const modoEdicion = document.getElementById("bugModoEdicion");
        const idEdicion = document.getElementById("bugIdEdicion");
        const casoRelacionadoInput =
            document.getElementById("bugCasoRelacionado");

        if (modoEdicion) modoEdicion.value = "false";
        if (idEdicion) idEdicion.value = "";

        window.evidenciasBugTemporales = [];
        const listaEvidencias = document.getElementById("listaEvidenciasBug");
        const contenidoLista = document.getElementById(
            "contenidoListaEvidenciasBug"
        );

        if (listaEvidencias) listaEvidencias.classList.add("hidden");
        if (contenidoLista) contenidoLista.innerHTML = "";

        if (titulo) {
            titulo.textContent = casoId
                ? "Reportar Bug desde Caso"
                : "Reportar Bug";
        }

        if (casoId) {
            const caso = window.casosActuales
                ? window.casosActuales.find((c) => c.ID === casoId)
                : null;

            if (caso) {
                if (casoRelacionadoInput) casoRelacionadoInput.value = casoId;

                const casoIdSpan = document.getElementById("casoRelacionadoId");
                const casoTituloSpan = document.getElementById(
                    "casoRelacionadoTitulo"
                );

                if (casoIdSpan) casoIdSpan.textContent = casoId;
                if (casoTituloSpan)
                    casoTituloSpan.textContent = caso.Titulo || "";
                if (infoCaso) infoCaso.classList.remove("hidden");

                preLlenarDesdeCaso(caso);
            } else {
                console.warn("‚ö†Ô∏è Caso no encontrado en casosActuales:", casoId);
            }
        } else {
            if (casoRelacionadoInput) casoRelacionadoInput.value = "";
            if (infoCaso) infoCaso.classList.add("hidden");
        }

        // Cargar opciones relacionadas con Trello (si existe configuraci√≥n)
        try {
            // Verificar que existe la funci√≥n y los elementos necesarios
            if (typeof cargarTrelloModal === "function") {
                if (
                    !document.getElementById("bugBoardSelect") ||
                    !document.getElementById("bugListSelect")
                ) {
                    console.warn(
                        "‚ö†Ô∏è Elementos de Trello no encontrados en el DOM"
                    );
                    return;
                }
                cargarTrelloModal();
            }
        } catch (e) {
            console.warn("No se pudo cargar Trello en modal:", e);
            // Ocultar secci√≥n de Trello si hay error
            const configured = document.getElementById("trelloBugConfigured");
            const notConfigured = document.getElementById(
                "trelloBugNotConfigured"
            );
            if (configured) configured.classList.add("hidden");
            if (notConfigured) notConfigured.style.display = "none";
        }

        // Si abrirModal no est√° disponible, usar una implementaci√≥n local
        const abrirModalFn =
            typeof abrirModal === "function"
                ? abrirModal
                : function (id) {
                      const modalElement = document.getElementById(id);
                      if (modalElement) {
                          modalElement.classList.add("active");
                          document.body.style.overflow = "hidden";
                      }
                  };

        try {
            abrirModalFn("modalCrearBug");
        } catch (e) {
            console.error("‚ùå Error al abrir modal:", e);
            // √öltimo intento de abrir el modal
            if (modal) {
                modal.classList.add("active");
                document.body.style.overflow = "hidden";
            }
        }
    };

    function preLlenarDesdeCaso(caso) {
        console.log("üìù Pre-llenando formulario desde caso...");

        const tituloSugerido =
            "Error en: " + (caso.Titulo || "").substring(0, 80);
        document.getElementById("bugTitulo").value = tituloSugerido;

        let descripcionBase =
            "Bug detectado durante la ejecuci√≥n del caso de prueba.\n\n";
        descripcionBase += "Caso: " + caso.ID + " - " + caso.Titulo;
        document.getElementById("bugDescripcion").value = descripcionBase;

        if (caso.Prioridad === "Critica" || caso.FlujoCritico === "Si") {
            document.getElementById("bugSeveridad").value = "Cr√≠tica";
            document.getElementById("bugPrioridad").value = "Alta";
        } else if (caso.Prioridad === "Alta") {
            document.getElementById("bugSeveridad").value = "Alta";
            document.getElementById("bugPrioridad").value = "Alta";
        } else {
            document.getElementById("bugSeveridad").value = "Media";
            document.getElementById("bugPrioridad").value = "Media";
        }

        if (caso.Precondiciones && caso.Precondiciones !== "") {
            document.getElementById("bugPrecondiciones").value =
                caso.Precondiciones;
        } else {
            document.getElementById("bugPrecondiciones").value =
                "Condiciones previas necesarias...";
        }

        if (caso.Formato === "Gherkin") {
            let pasos = "";
            if (caso.ScenarioGiven)
                pasos += "Dado: " + caso.ScenarioGiven + "\n";
            if (caso.ScenarioWhen)
                pasos += "Cuando: " + caso.ScenarioWhen + "\n";
            if (caso.ScenarioThen) pasos += "Entonces: " + caso.ScenarioThen;
            document.getElementById("bugPasosReproducir").value =
                pasos || "1. Paso uno\n2. Paso dos\n3. Paso tres";
        } else {
            if (caso.Pasos && caso.Pasos !== "") {
                document.getElementById("bugPasosReproducir").value =
                    caso.Pasos;
            } else {
                document.getElementById("bugPasosReproducir").value =
                    "1. Paso uno\n2. Paso dos\n3. Paso tres";
            }
        }

        if (caso.ResultadoEsperado && caso.ResultadoEsperado !== "") {
            document.getElementById("bugResultadoEsperado").value =
                caso.ResultadoEsperado;
        } else {
            document.getElementById("bugResultadoEsperado").value =
                "Describe el resultado esperado...";
        }

        document.getElementById("bugResultadoObtenido").value =
            "Describe aqu√≠ el comportamiento err√≥neo observado...";
        document.getElementById("bugDatosPrueba").value =
            "Indica los datos usados en la prueba que caus√≥ el error";

        console.log("‚úÖ Formulario pre-llenado");
    }

    function cerrarModalBug() {
        cerrarModal("modalCrearBug");
    }

    // ===================================================================
    // MANEJO DE EVIDENCIAS
    // ===================================================================

    function handleDragOverBug(event) {
        event.preventDefault();
        event.stopPropagation();
        document.getElementById("dropzoneBug").classList.add("drag-over");
    }

    function handleDragLeaveBug(event) {
        event.preventDefault();
        event.stopPropagation();
        document.getElementById("dropzoneBug").classList.remove("drag-over");
    }

    function handleDropBug(event) {
        event.preventDefault();
        event.stopPropagation();
        document.getElementById("dropzoneBug").classList.remove("drag-over");

        const files = event.dataTransfer.files;
        procesarArchivosBug(files);
    }

    function handleFileSelectBug(event) {
        const files = event.target.files;
        procesarArchivosBug(files);
        event.target.value = "";
    }

    // Click en dropzone
    document.addEventListener("DOMContentLoaded", function () {
        const dropzone = document.getElementById("dropzoneBug");
        if (dropzone) {
            dropzone.addEventListener("click", function () {
                document.getElementById("inputArchivosBug").click();
            });
        }
    });

    function procesarArchivosBug(files) {
        let archivosValidos = 0;

        for (let i = 0; i < files.length; i++) {
            const file = files[i];

            // MEJORA: L√≠mites diferenciados por tipo
            const maxSizeImagen = 10 * 1024 * 1024; // 10 MB
            const maxSizeVideo = 100 * 1024 * 1024; // 100 MB
            const maxSizePDF = 20 * 1024 * 1024; // 20 MB

            let maxSize = 50 * 1024 * 1024; // Default
            let tipoArchivo = "archivo";

            if (file.type.startsWith("image/")) {
                maxSize = maxSizeImagen;
                tipoArchivo = "imagen";
            } else if (file.type.startsWith("video/")) {
                maxSize = maxSizeVideo;
                tipoArchivo = "video";
            } else if (file.type === "application/pdf") {
                maxSize = maxSizePDF;
                tipoArchivo = "PDF";
            }

            if (file.size > maxSize) {
                const maxMB = (maxSize / (1024 * 1024)).toFixed(0);
                mostrarToast(
                    '‚ùå "' +
                        file.name +
                        '" excede el l√≠mite de ' +
                        maxMB +
                        " MB para " +
                        tipoArchivo +
                        "s",
                    "error",
                    5000
                );
                continue;
            }

            // Validar formatos de video
            if (file.type.startsWith("video/")) {
                const formatosPermitidos = [
                    "video/mp4",
                    "video/webm",
                    "video/quicktime",
                    "video/x-msvideo",
                    "video/x-matroska",
                ];

                if (!formatosPermitidos.includes(file.type)) {
                    mostrarToast(
                        '‚ö†Ô∏è Formato "' +
                            file.type +
                            '" no recomendado. Usa MP4, WebM o MOV',
                        "warning",
                        4000
                    );
                }
            }

            // Feedback para archivos grandes
            if (file.size > 20 * 1024 * 1024) {
                const nombreCorto =
                    file.name.length > 30
                        ? file.name.substring(0, 27) + "..."
                        : file.name;
                mostrarToast(
                    'üì§ Procesando "' +
                        nombreCorto +
                        '"... Puede tardar unos segundos',
                    "info",
                    3000
                );
            }

            const reader = new FileReader();
            reader.onload = function (e) {
                window.evidenciasBugTemporales.push({
                    tipo: "archivo",
                    nombre: file.name,
                    tama√±o: file.size,
                    mimeType: file.type,
                    contenidoBase64: e.target.result.split(",")[1],
                });

                renderizarListaEvidenciasBug();

                const tama√±oMB = (file.size / (1024 * 1024)).toFixed(2);

                // Emoji seg√∫n tipo
                let emoji = "‚úÖ";
                if (file.type.startsWith("video/")) emoji = "üé•";
                else if (file.type.startsWith("image/")) emoji = "üñºÔ∏è";
                else if (file.type === "application/pdf") emoji = "üìÑ";

                mostrarToast(
                    emoji + ' "' + file.name + '" listo (' + tama√±oMB + " MB)",
                    "success",
                    2000
                );
            };

            reader.onerror = function () {
                mostrarToast('‚ùå Error leyendo "' + file.name + '"', "error");
            };

            reader.readAsDataURL(file);
            archivosValidos++;
        }

        if (files.length > 1) {
            setTimeout(() => {
                if (archivosValidos > 0) {
                    mostrarToast(
                        "üìé " + archivosValidos + " archivo(s) agregado(s)",
                        "info",
                        2000
                    );
                }
            }, 500);
        }
    }

    function renderizarListaEvidenciasBug() {
        const lista = document.getElementById("listaEvidenciasBug");
        const contenido = document.getElementById(
            "contenidoListaEvidenciasBug"
        );

        if (window.evidenciasBugTemporales.length === 0) {
            lista.classList.add("hidden");
            return;
        }

        lista.classList.remove("hidden");

        let html = "";
        window.evidenciasBugTemporales.forEach((evidencia, index) => {
            const tama√±oMB = (evidencia.tama√±o / (1024 * 1024)).toFixed(2);

            html += '<div class="evidencia-item">';
            html +=
                '  <div style="display: flex; align-items: center; gap: 0.5rem; flex: 1;">';
            // Icono seg√∫n tipo de archivo
            let icono = "üìé";
            if (evidencia.mimeType.startsWith("image/")) {
                icono = "üñºÔ∏è";
            } else if (evidencia.mimeType.startsWith("video/")) {
                icono = "üé•";
            } else if (evidencia.mimeType === "application/pdf") {
                icono = "üìÑ";
            }

            html += '    <span style="font-size: 1.5rem;">' + icono + "</span>";
            html += '    <div style="flex: 1;">';
            html +=
                '      <div style="font-weight: 500; word-break: break-word;">' +
                evidencia.nombre +
                "</div>";
            html +=
                '      <div style="font-size: 0.85rem; color: #64748b;">' +
                tama√±oMB +
                " MB</div>";
            html += "    </div>";
            html += "  </div>";
            html +=
                '  <button type="button" class="btn-eliminar-evidencia" onclick="eliminarEvidenciaBug(' +
                index +
                ')" title="Eliminar">üóëÔ∏è</button>';
            html += "</div>";
        });

        contenido.innerHTML = html;
    }

    // ===================================================================
    // FUNCIONES TRELLO PARA EL MODAL DE BUG
    // ===================================================================

    /**
     * Carga la configuraci√≥n de Trello para este workspace y prepara la UI del modal
     */
    function cargarTrelloModal() {
        // Asegurar que la funci√≥n est√© disponible globalmente
        window.cargarTrelloModal = cargarTrelloModal;

        try {
            const elements = {
                enviarCheck: document.getElementById("bugEnviarATrello"),
                configured: document.getElementById("trelloBugConfigured"),
                notConfigured: document.getElementById(
                    "trelloBugNotConfigured"
                ),
                boardSelect: document.getElementById("bugBoardSelect"),
                listSelect: document.getElementById("bugListSelect"),
            };

            // Verificar elementos requeridos
            if (!elements.boardSelect || !elements.listSelect) {
                console.error(
                    "‚ùå Elementos requeridos de Trello no encontrados"
                );
                throw new Error("Elementos de Trello no encontrados");
            }

            // Reset
            elements.enviarCheck && (elements.enviarCheck.checked = true);
            elements.configured && elements.configured.classList.add("hidden");
            elements.notConfigured &&
                (elements.notConfigured.style.display = "none");
            elements.boardSelect.innerHTML =
                '<option value="">Cargando tableros...</option>';
            elements.boardSelect.disabled = true;
            elements.listSelect.innerHTML =
                '<option value="">Selecciona un tablero primero</option>';
            elements.listSelect.disabled = true;

            if (!window.currentSheetUrl) {
                if (notConfigured) notConfigured.style.display = "block";
                return;
            }

            // Primero obtener configuraci√≥n para saber si hay Trello configurado
            google.script.run
                .withSuccessHandler(function (config) {
                    if (config && config.configurado) {
                        // Mostrar UI configurada
                        if (configured) configured.classList.remove("hidden");
                        if (notConfigured) notConfigured.style.display = "none";

                        // Cargar boards usando credenciales guardadas
                        google.script.run
                            .withSuccessHandler(function (respBoards) {
                                if (!boardSelect) return;
                                boardSelect.disabled = false;
                                boardSelect.innerHTML =
                                    '<option value="">Selecciona un tablero</option>';

                                if (
                                    respBoards &&
                                    respBoards.success &&
                                    respBoards.data.length > 0
                                ) {
                                    respBoards.data.forEach(function (b) {
                                        const opt =
                                            document.createElement("option");
                                        opt.value = b.id;
                                        opt.textContent = b.name;
                                        opt.dataset.url = b.shortUrl || "";
                                        boardSelect.appendChild(opt);
                                    });

                                    // Preselect configured board if present
                                    if (config.boardId) {
                                        boardSelect.value = config.boardId;
                                        // cargar listas del board seleccionado
                                        cargarListasModalPorBoard(
                                            config.boardId,
                                            config.listId
                                        );
                                    }
                                } else {
                                    boardSelect.innerHTML =
                                        '<option value="">No se encontraron tableros</option>';
                                }
                            })
                            .withFailureHandler(function (err) {
                                if (boardSelect)
                                    boardSelect.innerHTML =
                                        '<option value="">Error cargando tableros</option>';
                                console.error(
                                    "Error cargando boards para modal:",
                                    err
                                );
                            })
                            .obtenerBoardsTrelloGuardados(
                                window.currentSheetUrl
                            );
                    } else {
                        if (notConfigured)
                            notConfigured.style.display = "block";
                    }
                })
                .withFailureHandler(function (error) {
                    console.error(
                        "Error obteniendo config Trello para modal:",
                        error
                    );
                    if (document.getElementById("trelloBugNotConfigured"))
                        document.getElementById(
                            "trelloBugNotConfigured"
                        ).style.display = "block";
                })
                .obtenerConfigTrello(window.currentSheetUrl);
        } catch (e) {
            console.error("Error en cargarTrelloModal:", e);
        }
    }

    /**
     * Carga las listas para el board seleccionado en el modal. Si se pasa listToSelect intenta preseleccionarlo.
     * @param {string} boardIdOverride - opcional boardId para forzar carga
     * @param {string} listToSelect - opcional listId para preseleccionar
     */
    function cargarListasModalPorBoard(boardIdOverride, listToSelect) {
        try {
            const boardSelect = document.getElementById("bugBoardSelect");
            const selectList = document.getElementById("bugListSelect");
            const boardId =
                boardIdOverride || (boardSelect ? boardSelect.value : "");

            if (!boardId) {
                if (selectList)
                    selectList.innerHTML =
                        '<option value="">Selecciona primero un tablero</option>';
                return;
            }

            if (selectList) {
                selectList.innerHTML =
                    '<option value="">Cargando listas...</option>';
                selectList.disabled = true;
            }

            google.script.run
                .withSuccessHandler(function (resp) {
                    if (!selectList) return;
                    selectList.disabled = false;

                    if (resp && resp.success && resp.data.length > 0) {
                        selectList.innerHTML =
                            '<option value="">Selecciona una lista</option>';
                        resp.data.forEach(function (l) {
                            const opt = document.createElement("option");
                            opt.value = l.id;
                            opt.textContent = l.name;
                            selectList.appendChild(opt);
                        });

                        if (listToSelect) selectList.value = listToSelect;
                    } else {
                        selectList.innerHTML =
                            '<option value="">No se encontraron listas</option>';
                    }
                })
                .withFailureHandler(function (err) {
                    if (selectList)
                        selectList.innerHTML =
                            '<option value="">Error cargando listas</option>';
                    console.error(
                        "Error cargando listas para modal (by board):",
                        err
                    );
                })
                .obtenerListasTrelloGuardadas(window.currentSheetUrl, boardId);
        } catch (e) {
            console.error("Error en cargarListasModalPorBoard:", e);
        }
        // Asegurar que la funci√≥n est√© disponible globalmente
        window.cargarListasModalPorBoard = cargarListasModalPorBoard;
    }

    // ===================================================================
    // CONFIGURACI√ìN TRELLO INLINE DENTRO DEL MODAL
    // ===================================================================

    function actualizarTrelloTokenUrl() {
        const apiKey = document
            .getElementById("trelloApiKeyInline")
            .value.trim();
        const tokenLink = document.getElementById("trelloTokenLink");
        if (apiKey) {
            tokenLink.href = `https://trello.com/1/authorize?expiration=never&name=AppQATool&scope=read,write&response_type=token&key=${apiKey}`;
        } else {
            tokenLink.href = "#";
        }
    }

    function abrirConfiguracionTrelloInline() {
        try {
            // Mostrar el inline config y ocultar mensajes previos
            document.getElementById("trelloInlineConfig").style.display =
                "block";
            // Cargar config actual para prellenar
            if (typeof window.currentSheetUrl === "undefined")
                window.currentSheetUrl = null;

            google.script.run
                .withSuccessHandler(function (config) {
                    if (!config) config = {};
                    const apiKeyInput =
                        document.getElementById("trelloApiKeyInline");
                    apiKeyInput.value = config.apiKey || "";
                    apiKeyInput.addEventListener(
                        "input",
                        actualizarTrelloTokenUrl
                    );
                    document.getElementById("trelloTokenInline").value =
                        config.token || "";
                    actualizarTrelloTokenUrl();

                    // Si ya hay credentials, mostrar paso de boards
                    if (config.apiKey && config.token) {
                        document.getElementById(
                            "trelloBoardListStepInline"
                        ).style.display = "block";
                        cargarBoardsTrelloInline(config.apiKey, config.token);
                    } else {
                        document.getElementById(
                            "trelloBoardListStepInline"
                        ).style.display = "none";
                        document.getElementById(
                            "btnGuardarConfigTrelloInline"
                        ).style.display = "none";
                    }
                })
                .withFailureHandler(function (err) {
                    console.error("Error cargando config Trello inline:", err);
                })
                .obtenerConfigTrello(window.currentSheetUrl);
        } catch (e) {
            console.error("abrirConfiguracionTrelloInline error:", e);
        }
    }

    function cerrarConfiguracionTrelloInline() {
        const el = document.getElementById("trelloInlineConfig");
        if (el) el.style.display = "none";
    }

    function validarCredencialesTrelloInline() {
        const apiKey = document
            .getElementById("trelloApiKeyInline")
            .value.trim();
        const token = document.getElementById("trelloTokenInline").value.trim();

        if (!apiKey || apiKey.length < 10) {
            mostrarToast("La API Key es requerida", "warning");
            return;
        }
        if (!token || token.length < 10) {
            mostrarToast("El Token es requerido", "warning");
            return;
        }

        const btn = document.getElementById("btnValidarCredencialesInline");
        btn.disabled = true;
        btn.textContent = "Validando...";

        mostrarSpinner();

        google.script.run
            .withSuccessHandler(function (resp) {
                ocultarSpinner();
                btn.disabled = false;
                btn.innerHTML = "üîê Validar";

                if (resp && resp.success) {
                    mostrarToast(
                        "‚úÖ Credenciales v√°lidas: " +
                            (resp.data ? resp.data.usuario : ""),
                        "success"
                    );
                    document.getElementById(
                        "trelloBoardListStepInline"
                    ).style.display = "block";
                    document.getElementById(
                        "btnGuardarConfigTrelloInline"
                    ).style.display = "inline-flex";
                    cargarBoardsTrelloInline(apiKey, token);
                } else {
                    mostrarToast(
                        "‚ùå " +
                            (resp
                                ? resp.mensaje
                                : "Error validando credenciales"),
                        "error"
                    );
                }
            })
            .withFailureHandler(function (err) {
                ocultarSpinner();
                btn.disabled = false;
                btn.innerHTML = "üîê Validar";
                mostrarToast(
                    "Error validando credenciales: " + err.message,
                    "error"
                );
            })
            .validarCredencialesTrello(apiKey, token);
    }

    function cargarBoardsTrelloInline(apiKey, token) {
        const selectBoard = document.getElementById("trelloBoardSelectInline");
        selectBoard.innerHTML =
            '<option value="">Cargando tableros...</option>';
        selectBoard.disabled = true;

        google.script.run
            .withSuccessHandler(function (response) {
                selectBoard.disabled = false;
                if (response && response.success && response.data.length > 0) {
                    selectBoard.innerHTML =
                        '<option value="">Selecciona un tablero</option>';
                    response.data.forEach(function (board) {
                        const option = document.createElement("option");
                        option.value = board.id;
                        option.textContent = board.name;
                        option.dataset.url = board.shortUrl || "";
                        selectBoard.appendChild(option);
                    });
                    mostrarToast(
                        "‚úÖ " + response.data.length + " tableros cargados",
                        "success"
                    );
                } else {
                    selectBoard.innerHTML =
                        '<option value="">No se encontraron tableros</option>';
                    mostrarToast("No tienes tableros en Trello", "warning");
                }
            })
            .withFailureHandler(function (err) {
                selectBoard.disabled = false;
                selectBoard.innerHTML =
                    '<option value="">Error cargando tableros</option>';
                mostrarToast(
                    "Error cargando tableros: " + err.message,
                    "error"
                );
            })
            .obtenerBoardsTrello(apiKey, token);
    }

    function cargarListasTrelloInline() {
        const selectBoard = document.getElementById("trelloBoardSelectInline");
        const selectList = document.getElementById("trelloListSelectInline");
        const apiKey = document
            .getElementById("trelloApiKeyInline")
            .value.trim();
        const token = document.getElementById("trelloTokenInline").value.trim();
        const boardId = selectBoard.value;

        if (!boardId) {
            selectList.innerHTML =
                '<option value="">Selecciona primero un tablero</option>';
            return;
        }

        selectList.innerHTML = '<option value="">Cargando listas...</option>';
        selectList.disabled = true;

        google.script.run
            .withSuccessHandler(function (response) {
                selectList.disabled = false;
                if (response && response.success && response.data.length > 0) {
                    selectList.innerHTML =
                        '<option value="">Selecciona una lista</option>';
                    response.data.forEach(function (lista) {
                        const option = document.createElement("option");
                        option.value = lista.id;
                        option.textContent = lista.name;
                        selectList.appendChild(option);
                    });
                    mostrarToast(
                        "‚úÖ " + response.data.length + " listas cargadas",
                        "success"
                    );
                } else {
                    selectList.innerHTML =
                        '<option value="">No se encontraron listas</option>';
                    mostrarToast("El tablero no tiene listas", "warning");
                }
            })
            .withFailureHandler(function (err) {
                selectList.disabled = false;
                selectList.innerHTML =
                    '<option value="">Error cargando listas</option>';
                mostrarToast("Error cargando listas: " + err.message, "error");
            })
            .obtenerListasTrello(apiKey, token, boardId);
    }

    function guardarConfiguracionTrelloInline() {
        const apiKey = document
            .getElementById("trelloApiKeyInline")
            .value.trim();
        const token = document.getElementById("trelloTokenInline").value.trim();
        const selectBoard = document.getElementById("trelloBoardSelectInline");
        const selectList = document.getElementById("trelloListSelectInline");

        const boardId = selectBoard ? selectBoard.value : "";
        const listId = selectList ? selectList.value : "";

        if (!apiKey || apiKey.length < 10) {
            mostrarToast("La API Key es requerida", "warning");
            return;
        }
        if (!token || token.length < 10) {
            mostrarToast("El Token es requerido", "warning");
            return;
        }
        if (!boardId || !listId) {
            mostrarToast("Selecciona un tablero y una lista", "warning");
            return;
        }

        const boardName =
            selectBoard.options[selectBoard.selectedIndex].text || "";
        const listName =
            selectList.options[selectList.selectedIndex].text || "";
        const boardUrl =
            selectBoard.options[selectBoard.selectedIndex].dataset.url || "";

        const configTrello = {
            apiKey: apiKey,
            token: token,
            boardId: boardId,
            listId: listId,
            boardUrl: boardUrl,
            boardName: boardName,
            listName: listName,
        };

        const btn = document.getElementById("btnGuardarConfigTrelloInline");
        btn.disabled = true;
        btn.textContent = "Guardando...";

        mostrarSpinner();

        google.script.run
            .withSuccessHandler(function (guardado) {
                ocultarSpinner();
                btn.disabled = false;
                btn.innerHTML = "üíæ Guardar";

                if (guardado) {
                    mostrarToast(
                        "‚úÖ Configuraci√≥n de Trello guardada",
                        "success"
                    );
                    // Cerrar inline y recargar options del modal
                    cerrarConfiguracionTrelloInline();
                    setTimeout(function () {
                        if (typeof cargarTrelloModal === "function")
                            cargarTrelloModal();
                    }, 600);
                } else {
                    mostrarToast("Error al guardar configuraci√≥n", "error");
                }
            })
            .withFailureHandler(function (err) {
                ocultarSpinner();
                btn.disabled = false;
                btn.innerHTML = "üíæ Guardar";
                mostrarToast(
                    "Error guardando configuraci√≥n: " + err.message,
                    "error"
                );
            })
            .guardarConfigTrello(configTrello, window.currentSheetUrl);
    }

    function eliminarEvidenciaBug(index) {
        window.evidenciasBugTemporales.splice(index, 1);
        renderizarListaEvidenciasBug();
        mostrarToast("‚úÖ Evidencia eliminada", "success");
    }

    // ===================================================================
    // GUARDAR BUG (feature/bugs-trello)
    // ===================================================================

    async function guardarBug() {
        console.log("üíæ Guardando bug...");

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // VALIDACIONES DE CAMPOS OBLIGATORIOS
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        const titulo = document.getElementById("bugTitulo").value.trim();
        const descripcion = document
            .getElementById("bugDescripcion")
            .value.trim();
        const precondiciones = document
            .getElementById("bugPrecondiciones")
            .value.trim();
        const datosPrueba = document
            .getElementById("bugDatosPrueba")
            .value.trim();
        const pasosReproducir = document
            .getElementById("bugPasosReproducir")
            .value.trim();
        const resultadoEsperado = document
            .getElementById("bugResultadoEsperado")
            .value.trim();
        const resultadoObtenido = document
            .getElementById("bugResultadoObtenido")
            .value.trim();

        if (!titulo || titulo.length < 10) {
            mostrarToast(
                "El t√≠tulo debe tener al menos 10 caracteres",
                "warning"
            );
            return;
        }

        if (!descripcion || descripcion.length < 10) {
            mostrarToast(
                "La descripci√≥n debe tener al menos 10 caracteres",
                "warning"
            );
            return;
        }

        if (!precondiciones || precondiciones.length < 10) {
            mostrarToast(
                "Las precondiciones son obligatorias (m√≠n. 10 caracteres)",
                "warning"
            );
            return;
        }

        if (!datosPrueba || datosPrueba.length < 10) {
            mostrarToast(
                "Los datos de prueba son obligatorios (m√≠n. 10 caracteres)",
                "warning"
            );
            return;
        }

        if (!pasosReproducir || pasosReproducir.length < 10) {
            mostrarToast(
                "Los pasos para reproducir son obligatorios (m√≠n. 10 caracteres)",
                "warning"
            );
            return;
        }

        if (!resultadoEsperado || resultadoEsperado.length < 10) {
            mostrarToast(
                "El resultado esperado es obligatorio (m√≠n. 10 caracteres)",
                "warning"
            );
            return;
        }

        if (!resultadoObtenido || resultadoObtenido.length < 10) {
            mostrarToast(
                "El resultado obtenido es obligatorio (m√≠n. 10 caracteres)",
                "warning"
            );
            return;
        }

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // PREPARAR DATOS DEL BUG
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        const sheetUrl = window.currentSheetUrl;

        if (!sheetUrl) {
            console.error("‚ùå No hay currentSheetUrl disponible");
            console.log("window.currentSheetUrl:", window.currentSheetUrl);
            mostrarToast(
                "‚ùå Error: No hay Sheet conectado. Recarga la p√°gina e intenta de nuevo.",
                "error"
            );
            return;
        }

        console.log("‚úÖ Sheet URL obtenida:", sheetUrl);

        const casoRelacionado = document
            .getElementById("bugCasoRelacionado")
            .value.trim();

        const datosBug = {
            sheetUrl: sheetUrl,
            titulo: titulo,
            descripcion: descripcion,
            severidad: document.getElementById("bugSeveridad").value,
            prioridad: document.getElementById("bugPrioridad").value,
            precondiciones: precondiciones,
            datosPrueba: datosPrueba,
            pasosReproducir: pasosReproducir,
            resultadoEsperado: resultadoEsperado,
            resultadoObtenido: resultadoObtenido,
            ambiente: document.getElementById("bugAmbiente").value,
            navegador: document.getElementById("bugNavegador").value,
            etiquetas: document.getElementById("bugEtiquetas").value,
            notas: document.getElementById("bugNotas").value,
            tieneCasoDise√±ado: casoRelacionado ? true : false,
            casosRelacionados: casoRelacionado || "",
            origenSinCaso: casoRelacionado ? "" : "Manual",
            evidencias: [], // Solo nombres para referencia
            evidenciasBase64: [], // ‚Üê NUEVO: Contenido completo para subir
            // Opciones Trello (compacto en modal)
            enviarATrello: document.getElementById("bugEnviarATrello")
                ? document.getElementById("bugEnviarATrello").checked
                : true,
            trelloListOverride: document.getElementById("bugListSelect")
                ? document.getElementById("bugListSelect").value
                : "",
        };

        // MEJORA 4: Agregar evidencias con contenido Base64 completo
        if (
            window.evidenciasBugTemporales &&
            window.evidenciasBugTemporales.length > 0
        ) {
            // Nombres para referencia r√°pida
            datosBug.evidencias = window.evidenciasBugTemporales.map(
                (e) => e.nombre
            );

            // Contenido completo Base64 para subir a Drive
            datosBug.evidenciasBase64 = window.evidenciasBugTemporales.map(
                function (e) {
                    return {
                        nombre: e.nombre,
                        mimeType: e.mimeType,
                        contenidoBase64: e.contenidoBase64,
                        tama√±o: e.tama√±o,
                    };
                }
            );

            console.log(
                "üìé " +
                    datosBug.evidenciasBase64.length +
                    " evidencias preparadas para subir"
            );
        }

        console.log("üì¶ Datos del bug:", datosBug);

        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
        // LLAMAR AL BACKEND
        // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

        mostrarSpinner();

        google.script.run
            .withSuccessHandler(function (response) {
                ocultarSpinner();

                console.log("üì® Respuesta del backend:", response);

                if (response.success) {
                    const bugId = response.data.bugId;
                    const trelloCreado = response.data.trelloCreado || false;
                    const trelloIntentado =
                        response.data.trelloIntentado || false;
                    const trelloUrl = response.data.trelloUrl || "";
                    const trelloError = response.data.trelloError || "";

                    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                    // MENSAJES DIFERENCIADOS SEG√öN ESCENARIOS (feature/bugs-trello)
                    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

                    if (trelloCreado) {
                        // ‚úÖ ESCENARIO 1: √âxito con Trello
                        mostrarToast(
                            "‚úÖ Bug " +
                                bugId +
                                " creado y enviado a Trello exitosamente",
                            "success",
                            4000
                        );

                        // Mostrar notificaci√≥n adicional con link a Trello
                        setTimeout(function () {
                            if (trelloUrl) {
                                mostrarNotificacionTrello(bugId, trelloUrl);
                            }
                        }, 1000);
                    }
                    if (window.evidenciasBugTemporales.length > 0) {
                        const cantEvidencias =
                            window.evidenciasBugTemporales.length;
                        setTimeout(function () {
                            mostrarToast(
                                "üìé " +
                                    cantEvidencias +
                                    " evidencia(s) subida(s) a Drive",
                                "info",
                                3000
                            );
                        }, 2000);
                    } else if (trelloIntentado && trelloError) {
                        // ‚ö†Ô∏è ESCENARIO 3: Error en Trello pero bug guardado
                        mostrarToast(
                            "‚ö†Ô∏è Bug " +
                                bugId +
                                " guardado. Error al sincronizar con Trello: " +
                                trelloError,
                            "warning",
                            5000
                        );

                        console.warn("Trello sync error:", trelloError);
                    } else if (!trelloIntentado) {
                        // ‚ÑπÔ∏è ESCENARIO 2: Sin Trello configurado
                        mostrarToast(
                            "‚úÖ Bug " +
                                bugId +
                                " guardado. Trello no configurado",
                            "info",
                            4000
                        );

                        // Ofrecer configurar Trello
                        setTimeout(function () {
                            mostrarSugerenciaConfigurarTrello();
                        }, 1500);
                    } else {
                        // Fallback gen√©rico
                        mostrarToast(
                            "‚úÖ Bug " + bugId + " creado exitosamente",
                            "success"
                        );
                    }

                    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                    // LIMPIAR FORMULARIO
                    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

                    // Limpiar campos obligatorios
                    document.getElementById("bugTitulo").value = "";
                    document.getElementById("bugDescripcion").value = "";
                    document.getElementById("bugPrecondiciones").value = "";
                    document.getElementById("bugDatosPrueba").value = "";
                    document.getElementById("bugPasosReproducir").value = "";
                    document.getElementById("bugResultadoEsperado").value = "";
                    document.getElementById("bugResultadoObtenido").value = "";

                    // Limpiar campos opcionales
                    document.getElementById("bugAmbiente").value = "";
                    document.getElementById("bugNavegador").value = "";
                    document.getElementById("bugEtiquetas").value = "";
                    document.getElementById("bugNotas").value = "";

                    // Resetear severidad y prioridad a valores por defecto
                    document.getElementById("bugSeveridad").value = "Media";
                    document.getElementById("bugPrioridad").value = "Media";

                    // Limpiar evidencias
                    window.evidenciasBugTemporales = [];
                    const listaEvidencias =
                        document.getElementById("listaEvidenciasBug");
                    if (listaEvidencias)
                        listaEvidencias.classList.add("hidden");

                    // Cerrar modal de bugs
                    cerrarModalBug();

                    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                    // SINCRONIZACI√ìN CON MODAL DE EJECUCI√ìN
                    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

                    // Marcar bug creado recientemente para el caso
                    try {
                        window.__ultimoBugCreado = {
                            bugId: bugId,
                            casoId: casoRelacionado || null,
                            at: Date.now(),
                        };
                    } catch (e) {
                        console.warn("No se pudo marcar √∫ltimo bug creado:", e);
                    }

                    // Si el modal de ejecuci√≥n est√° abierto para este caso, preparar No_OK
                    try {
                        if (
                            window.casoEnEjecucion &&
                            casoRelacionado &&
                            window.casoEnEjecucion.ID === casoRelacionado
                        ) {
                            // Setear resultado en UI
                            const resInput =
                                document.getElementById("resultadoEjecucion");
                            if (resInput) resInput.value = "No_OK";
                            if (typeof seleccionarResultado === "function") {
                                seleccionarResultado("No_OK");
                            }

                            // Agregar referencia al bug en observaciones
                            const obs = document.getElementById(
                                "ejecucionComentarios"
                            );
                            if (obs && obs.value.indexOf(bugId) === -1) {
                                obs.value =
                                    (obs.value ? obs.value + "\n" : "") +
                                    "Bug reportado: " +
                                    bugId;
                            }

                            // Guardar ejecuci√≥n autom√°ticamente
                            if (typeof guardarEjecucion === "function") {
                                setTimeout(function () {
                                    guardarEjecucion();
                                }, 400);
                            }
                        }
                    } catch (e) {
                        console.warn(
                            "No se pudo sincronizar con modal de ejecuci√≥n:",
                            e
                        );
                    }

                    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
                    // ACTUALIZAR TABLA DE CASOS
                    // ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê

                    if (casoRelacionado) {
                        console.log(
                            "Bug " +
                                bugId +
                                " vinculado al caso " +
                                casoRelacionado
                        );
                    }

                    // Recargar tabla de casos si est√° visible
                    if (typeof cargarTodosLosCasos === "function") {
                        setTimeout(function () {
                            cargarTodosLosCasos();
                        }, 500);
                    }
                } else {
                    // Error general
                    mostrarToast("Error: " + response.mensaje, "error");
                }
            })
            .withFailureHandler(function (error) {
                ocultarSpinner();
                console.error("üí• Error llamando al backend:", error);
                mostrarToast("Error al crear bug: " + error.message, "error");
            })
            .crearBug(datosBug);
    }

    // ===================================================================
    // NOTIFICACIONES ESPECIALES DE TRELLO (feature/bugs-trello)
    // ===================================================================

    /**
     * Muestra una notificaci√≥n especial con link a la tarjeta de Trello
     */
    function mostrarNotificacionTrello(bugId, trelloUrl) {
        const notification = document.getElementById("notification");
        const icon = document.getElementById("notificationIcon");
        const messageEl = document.getElementById("notificationMessage");

        if (!notification) return;

        // Configurar notificaci√≥n especial
        notification.className = "notification show success";
        icon.textContent = "üé´";

        // Crear mensaje con link
        messageEl.innerHTML =
            'üé´ Tarjeta creada en Trello: <a href="' +
            trelloUrl +
            '" target="_blank" style="color: white; text-decoration: underline; font-weight: bold;">' +
            bugId +
            "</a>";

        // Mostrar
        setTimeout(function () {
            notification.classList.add("show");
        }, 100);

        // Ocultar despu√©s de 6 segundos
        setTimeout(function () {
            notification.classList.remove("show");
        }, 6000);
    }

    /**
     * Muestra sugerencia para configurar Trello
     */
    function mostrarSugerenciaConfigurarTrello() {
        // Solo mostrar si no se ha mostrado antes en esta sesi√≥n
        if (window.__trelloSugerenciaMostrada) {
            return;
        }

        window.__trelloSugerenciaMostrada = true;

        const notification = document.getElementById("notification");
        const icon = document.getElementById("notificationIcon");
        const messageEl = document.getElementById("notificationMessage");

        if (!notification) return;

        notification.className = "notification show info";
        icon.textContent = "‚ÑπÔ∏è";

        messageEl.innerHTML =
            "üí° Tip: Configura Trello para sincronizar bugs autom√°ticamente. " +
            '<span style="cursor: pointer; text-decoration: underline; font-weight: bold;" ' +
            'onclick="abrirConfiguracionTrelloInline()">Configurar ahora</span>';

        setTimeout(function () {
            notification.classList.add("show");
        }, 100);

        setTimeout(function () {
            notification.classList.remove("show");
        }, 8000);
    }

    // ===================================================================
    // CAMBIAR ESTADO DE BUG (MEJORA 5)
    // ===================================================================

    /**
     * Inicia el proceso de cambiar estado de un bug
     * @param {string} bugId - ID del bug
     * @param {string} nuevoEstado - Nuevo estado (Cerrado, Resuelto, etc.)
     */
    function iniciarCambioEstadoBug(bugId, nuevoEstado) {
        console.log("üîÑ Iniciando cambio de estado:", bugId, "a", nuevoEstado);

        mostrarSpinner();

        google.script.run
            .withSuccessHandler(function (validacion) {
                ocultarSpinner();

                if (!validacion.success) {
                    mostrarToast("Error: " + validacion.mensaje, "error");
                    return;
                }

                // Si requiere confirmaci√≥n (tiene casos en No_OK)
                if (
                    validacion.requiereConfirmacion &&
                    validacion.casosEnNoOK &&
                    validacion.casosEnNoOK.length > 0
                ) {
                    mostrarModalConfirmacionCambioEstado(
                        bugId,
                        nuevoEstado,
                        validacion.casosEnNoOK
                    );
                } else {
                    // No requiere confirmaci√≥n, cambiar directamente
                    ejecutarCambioEstadoBug(bugId, nuevoEstado, []);
                }
            })
            .withFailureHandler(function (error) {
                ocultarSpinner();
                mostrarToast("Error: " + error.message, "error");
            })
            .validarCambioEstadoBug(window.currentSheetUrl, bugId, nuevoEstado);
    }

    /**
     * Muestra el modal de confirmaci√≥n con los casos afectados
     */
    function mostrarModalConfirmacionCambioEstado(
        bugId,
        nuevoEstado,
        casosEnNoOK
    ) {
        document.getElementById("bugIdCambiarEstado").value = bugId;
        document.getElementById("nuevoEstadoBug").value = nuevoEstado;

        // Mostrar advertencia y lista de casos
        const advertencia = document.getElementById("advertenciaCasosNoOK");
        const listaCasos = document.getElementById("listaCasosNoOK");

        advertencia.classList.remove("hidden");

        let html = "";
        casosEnNoOK.forEach(function (caso) {
            html +=
                "<li><strong>" +
                caso.id +
                "</strong> - " +
                caso.titulo +
                " <em>(" +
                caso.hoja +
                ")</em></li>";
        });
        listaCasos.innerHTML = html;

        // Marcar checkbox por defecto
        document.getElementById("actualizarCasosCheck").checked = true;

        abrirModal("modalCambiarEstadoBug");
    }

    /**
     * Confirma el cambio de estado y ejecuta la actualizaci√≥n
     */
    function confirmarCambioEstadoBug() {
        const bugId = document.getElementById("bugIdCambiarEstado").value;
        const nuevoEstado = document.getElementById("nuevoEstadoBug").value;
        const actualizarCasos = document.getElementById(
            "actualizarCasosCheck"
        ).checked;

        cerrarModalCambiarEstado();

        if (actualizarCasos) {
            ejecutarCambioEstadoConActualizacion(bugId, nuevoEstado);
        } else {
            ejecutarCambioEstadoBug(bugId, nuevoEstado, []);
        }
    }

    /**
     * Ejecuta el cambio de estado sin actualizar casos
     */
    function ejecutarCambioEstadoBug(bugId, nuevoEstado, casosIds) {
        mostrarSpinner();

        google.script.run
            .withSuccessHandler(function (response) {
                ocultarSpinner();

                if (response.success) {
                    mostrarToast(
                        "‚úÖ Estado del bug actualizado a: " + nuevoEstado,
                        "success"
                    );

                    // Recargar lista de bugs si existe
                    if (typeof cargarBugs === "function") {
                        setTimeout(function () {
                            cargarBugs();
                        }, 500);
                    }
                } else {
                    mostrarToast("Error: " + response.mensaje, "error");
                }
            })
            .withFailureHandler(function (error) {
                ocultarSpinner();
                mostrarToast("Error: " + error.message, "error");
            })
            .cambiarEstadoBug(window.currentSheetUrl, bugId, nuevoEstado);
    }

    /**
     * Ejecuta el cambio de estado Y actualiza los casos a OK
     */
    function ejecutarCambioEstadoConActualizacion(bugId, nuevoEstado) {
        mostrarSpinner();

        // Primero cambiar estado del bug
        google.script.run
            .withSuccessHandler(function (response) {
                if (response.success) {
                    // Ahora obtener los casos y actualizarlos
                    google.script.run
                        .withSuccessHandler(function (resultadoCasos) {
                            ocultarSpinner();

                            if (resultadoCasos.success) {
                                const casosIds =
                                    resultadoCasos.data.casos || [];

                                if (casosIds.length > 0) {
                                    // Actualizar casos
                                    actualizarCasosTrasCerrarBug(
                                        bugId,
                                        casosIds
                                    );
                                } else {
                                    mostrarToast(
                                        "‚úÖ Estado del bug actualizado",
                                        "success"
                                    );
                                }
                            }
                        })
                        .withFailureHandler(function (error) {
                            ocultarSpinner();
                            mostrarToast(
                                "Bug actualizado pero error obteniendo casos: " +
                                    error.message,
                                "warning"
                            );
                        })
                        .obtenerCasosPorBug(window.currentSheetUrl, bugId);
                } else {
                    ocultarSpinner();
                    mostrarToast("Error: " + response.mensaje, "error");
                }
            })
            .withFailureHandler(function (error) {
                ocultarSpinner();
                mostrarToast("Error: " + error.message, "error");
            })
            .cambiarEstadoBug(window.currentSheetUrl, bugId, nuevoEstado);
    }

    /**
     * Actualiza los casos asociados a OK
     */
    function actualizarCasosTrasCerrarBug(bugId, casosIds) {
        mostrarSpinner();

        google.script.run
            .withSuccessHandler(function (resultado) {
                ocultarSpinner();

                if (resultado.success) {
                    const cant = resultado.casosActualizados.length;
                    mostrarToast(
                        "‚úÖ Bug actualizado. " +
                            cant +
                            " caso(s) cambiado(s) a OK",
                        "success",
                        4000
                    );

                    // Recargar listas
                    if (typeof cargarBugs === "function") {
                        setTimeout(function () {
                            cargarBugs();
                        }, 500);
                    }
                    if (typeof cargarTodosLosCasos === "function") {
                        setTimeout(function () {
                            cargarTodosLosCasos();
                        }, 500);
                    }
                } else {
                    mostrarToast(
                        "Error actualizando casos: " + resultado.mensaje,
                        "warning"
                    );
                }
            })
            .withFailureHandler(function (error) {
                ocultarSpinner();
                mostrarToast("Error: " + error.message, "error");
            })
            .actualizarCasosAlCerrarBug(
                window.currentSheetUrl,
                bugId,
                casosIds
            );
    }

    /**
     * Cierra el modal de cambio de estado
     */
    function cerrarModalCambiarEstado() {
        cerrarModal("modalCambiarEstadoBug");

        // Limpiar campos
        document.getElementById("bugIdCambiarEstado").value = "";
        document.getElementById("nuevoEstadoBug").value = "";
        document.getElementById("advertenciaCasosNoOK").classList.add("hidden");
        document.getElementById("listaCasosNoOK").innerHTML = "";
    }

    // ===================================================================
    // EXPORTAR AL SCOPE GLOBAL
    // ===================================================================

    window.abrirModalCrearBug = abrirModalCrearBug;
    window.cerrarModalBug = cerrarModalBug;
    window.preLlenarDesdeCaso = preLlenarDesdeCaso;
    window.handleDragOverBug = handleDragOverBug;
    window.handleDragLeaveBug = handleDragLeaveBug;
    window.handleDropBug = handleDropBug;
    window.handleFileSelectBug = handleFileSelectBug;
    window.procesarArchivosBug = procesarArchivosBug;
    window.renderizarListaEvidenciasBug = renderizarListaEvidenciasBug;
    window.eliminarEvidenciaBug = eliminarEvidenciaBug;
    window.guardarBug = guardarBug;
    // Exportar funciones de Trello (feature/bugs-trello)
    window.mostrarNotificacionTrello = mostrarNotificacionTrello;
    window.mostrarSugerenciaConfigurarTrello =
        mostrarSugerenciaConfigurarTrello;
    // Exportar funciones de cambio de estado (MEJORA 5)
    window.iniciarCambioEstadoBug = iniciarCambioEstadoBug;
    window.confirmarCambioEstadoBug = confirmarCambioEstadoBug;
    window.cerrarModalCambiarEstado = cerrarModalCambiarEstado;

    console.log("‚úÖ Frontend_Components_Bugs.html cargado correctamente");
</script>

<!--
  FRONTEND_COMPONENTS_BUGS_LIST.HTML
  Listado / hist√≥rico de bugs con filtros y acciones
-->

<div id="bugsScreen" class="hidden" style="padding: 1rem;">
  <div class="card" style="margin-top: 0.5rem;">
    <div class="card-header" style="display:flex; align-items:center; justify-content:space-between; gap:1rem; flex-wrap:wrap;">
      <div style="display:flex; align-items:center; gap:0.5rem;">
        <button class="btn btn-secondary btn-sm" onclick="ocultarPanelBugs()">‚¨Ö Volver</button>
        <div style="font-weight:700; color:#334155;">üêõ Historial de Bugs</div>
      </div>
      <div style="display:flex; gap:0.5rem;">
        <button class="btn btn-primary" onclick="abrirModalCrearBug('')">Nuevo Bug</button>
      </div>
    </div>
    <div class="card-body">
      <!-- Filtros -->
      <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap:0.75rem; margin-bottom:0.75rem;">
        <input id="bugFiltroBusqueda" class="input-field" placeholder="Buscar por t√≠tulo o descripci√≥n" oninput="cargarBugs()" />
        <select id="bugFiltroEstado" class="input-field" onchange="cargarBugs()">
          <option value="Todos">Estado: Todos</option>
          <option value="Abierto">Abierto</option>
          <option value="Cerrado">Cerrado</option>
        </select>
        <select id="bugFiltroSeveridad" class="input-field" onchange="cargarBugs()">
          <option value="Todas">Severidad: Todas</option>
          <option value="Cr√≠tica">Cr√≠tica</option>
          <option value="Alta">Alta</option>
          <option value="Media">Media</option>
          <option value="Baja">Baja</option>
        </select>
        <select id="bugFiltroConCaso" class="input-field" onchange="cargarBugs()">
          <option value="Todos">Relaci√≥n: Todos</option>
          <option value="ConCaso">Con Caso</option>
          <option value="SinCaso">Sin Caso</option>
        </select>
      </div>
      <div class="table-responsive">
        <table class="table">
          <thead>
            <tr>
              <th style="width:90px;">ID</th>
              <th>T√≠tulo</th>
              <th>Estado</th>
              <th>Severidad</th>
              <th>Casos</th>
              <th>Link Caso</th>
              <th>Fecha</th>
              <th style="width:220px;">Acciones</th>
            </tr>
          </thead>
          <tbody id="tablaBugs"></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<script>
  function mostrarPanelBugs() {
    try { console.log('üêõ [Bugs] Abrir historial'); } catch(e){}
    const bugsScreen = document.getElementById('bugsScreen');
    const casosScreen = document.getElementById('casosScreen');
    if (casosScreen) casosScreen.classList.add('hidden');
    if (bugsScreen) bugsScreen.classList.remove('hidden');
    try { cargarBugs(); } catch(e) { console.error('üêõ Error cargarBugs init:', e); }
  }

  function ocultarPanelBugs() {
    const bugsScreen = document.getElementById('bugsScreen');
    const casosScreen = document.getElementById('casosScreen');
    if (bugsScreen) bugsScreen.classList.add('hidden');
    if (casosScreen) casosScreen.classList.remove('hidden');
  }

  function cargarBugs() {
    const url = (typeof recuperarSheetUrl === 'function') ? recuperarSheetUrl() : null;
    if (!url) { console.warn('üêõ [Bugs] No hay sheetUrl'); mostrarToast && mostrarToast('Conecta un Sheet primero','warning'); return; }
    const filtros = {};
    const busqueda = document.getElementById('bugFiltroBusqueda')?.value.trim() || '';
    const estado = document.getElementById('bugFiltroEstado')?.value || 'Todos';
    const severidad = document.getElementById('bugFiltroSeveridad')?.value || 'Todas';
    const relacion = document.getElementById('bugFiltroConCaso')?.value || 'Todos';
    if (busqueda) filtros.busqueda = busqueda;
    if (estado && estado !== 'Todos') filtros.estado = estado;
    if (severidad && severidad !== 'Todas') filtros.severidad = severidad;
    if (relacion === 'ConCaso') filtros.conCaso = true; else if (relacion === 'SinCaso') filtros.conCaso = false;
    console.log('üêõ [Bugs] Listar con filtros:', filtros);
    if (typeof mostrarSpinner === 'function') mostrarSpinner();
    google.script.run
      .withSuccessHandler(function(res){\n        console.log('?? [Bugs] Respuesta listarBugs:', res);\n        if (!res) {\n          console.warn('?? [Bugs] api_listarBugs devolviÛ null; intento fallback listarBugs');\n          google.script.run\n            .withSuccessHandler(function(r2){\n              console.log('?? [Bugs] Respuesta listarBugs (fallback):', r2);\n              if (typeof ocultarSpinner === 'function') ocultarSpinner();\n              if (!r2 || !r2.success) { mostrarToast && mostrarToast('No se pudieron listar bugs (fallback)', 'error'); renderizarTablaBugs([]); return; }\n              renderizarTablaBugs((r2.data && r2.data.bugs) ? r2.data.bugs : []);\n            })\n            .withFailureHandler(function(e2){ if (typeof ocultarSpinner==='function') ocultarSpinner(); console.error('?? [Bugs] Error listarBugs (fallback):', e2); mostrarToast && mostrarToast('Error listando bugs', 'error'); renderizarTablaBugs([]); })\n            .listarBugs(url, filtros);\n          return;\n        }\n        if (typeof ocultarSpinner === 'function') ocultarSpinner();\n        if (!res.success) { mostrarToast && mostrarToast('No se pudieron listar bugs: ' + (res.mensaje||''), 'error'); renderizarTablaBugs([]); return; }\n        renderizarTablaBugs((res.data && res.data.bugs) ? res.data.bugs : []);\n      })\n      .withFailureHandler(function(err){ if (typeof ocultarSpinner==='function') ocultarSpinner(); console.error('üêõ [Bugs] Error listarBugs:', err); if (typeof mostrarToast==='function') mostrarToast('Error listando bugs: ' + (err?.message||err),'error'); })
      .api_listarBugs(url, filtros);
  }

  function renderizarTablaBugs(bugs) {
    const tbody = document.getElementById('tablaBugs');
    if (!tbody) return;
    if (!bugs || bugs.length===0) {
      tbody.innerHTML = '<tr><td colspan="8" style="text-align:center; padding:1rem; color:#64748b;">Sin bugs para mostrar</td></tr>';
      return;
    }
    let html='';
    bugs.forEach(function(b){
      const id = b.ID || '';
      const titulo = b.Titulo || '';
      const estado = b.Estado || 'Abierto';
      const sev = b.Severidad || '';
      const casos = b.CasosRelacionados || '';
      const link = b.LinkCasoPrueba || '';
      const fecha = (function(){ try { return (b.FechaDeteccion && (new Date(b.FechaDeteccion)).toLocaleDateString()); } catch(e){ return '' } })();
      const badge = estado==='Cerrado' ? '<span class="badge badge-success">Cerrado</span>' : '<span class="badge badge-danger">Abierto</span>';
      const linkHtml = link ? link.split('\n').map(function(l){return '<a href="'+l+'" target="_blank">Link</a>';}).join('<br>') : '';
      html += '<tr>'+
        '<td>'+id+'</td>'+
        '<td>'+titulo+'</td>'+
        '<td>'+badge+'</td>'+
        '<td>'+sev+'</td>'+
        '<td>'+(casos||'')+'</td>'+
        '<td>'+linkHtml+'</td>'+
        '<td>'+(fecha||'')+'</td>'+
        '<td style="display:flex; gap:0.35rem; flex-wrap:wrap;">'+
          '<button class="btn btn-secondary btn-sm" onclick="abrirModalCrearBug(\''+id+'\')">Ver/Editar</button>'+
          (estado==='Abierto'
            ? '<button class="btn btn-success btn-sm" onclick="cambiarEstadoBugUI(\''+id+'\',\'Cerrado\')">Cerrar</button>'
            : '<button class="btn btn-primary btn-sm" onclick="cambiarEstadoBugUI(\''+id+'\',\'Abierto\')">Abrir</button>')+
          '<button class="btn btn-danger btn-sm" onclick="eliminarBugUI(\''+id+'\')">Eliminar</button>'+
        '</td>'+
      '</tr>';
    });
    tbody.innerHTML = html;
  }

  function cambiarEstadoBugUI(bugId, nuevoEstado) {
    const url = (typeof recuperarSheetUrl === 'function') ? recuperarSheetUrl() : null;
    if (!url) return;
    if (typeof mostrarSpinner==='function') mostrarSpinner();
    google.script.run
      .withSuccessHandler(function(r){ if (typeof ocultarSpinner==='function') ocultarSpinner(); if (r && r.success){ cargarBugs(); mostrarToast && mostrarToast('Estado actualizado','success'); } else { mostrarToast && mostrarToast('Error: '+(r?.mensaje||''),'error'); } })
      .withFailureHandler(function(e){ if (typeof ocultarSpinner==='function') ocultarSpinner(); mostrarToast && mostrarToast('Error: '+(e?.message||e),'error'); })
      .cambiarEstadoBug(url, bugId, nuevoEstado);
  }

  async function eliminarBugUI(bugId) {
    const confirmar = (typeof mostrarConfirmacionApp==='function')
      ? await mostrarConfirmacionApp({
          titulo: 'Eliminar Bug',
          icono: '‚ö†Ô∏è',
          mensaje: 'Al eliminar este bug, los casos vinculados que est√©n en No_OK y sin otros bugs abiertos pasar√°n a <strong>Sin ejecutar</strong>. ¬øConfirm√°s?',
          textoOk: 'S√≠, eliminar',
          textoCancelar: 'Cancelar'
        })
      : confirm('Eliminar bug '+bugId+'? Los casos con No_OK podr√≠an pasar a Sin ejecutar.');
    if (!confirmar) return;
    const url = (typeof recuperarSheetUrl === 'function') ? recuperarSheetUrl() : null;
    if (!url) return;
    if (typeof mostrarSpinner==='function') mostrarSpinner();
    google.script.run
      .withSuccessHandler(function(r){
        if (typeof ocultarSpinner==='function') ocultarSpinner();
        if (r && r.success){
          if (typeof mostrarToast==='function') mostrarToast('Bug eliminado', 'success');
          cargarBugs();
          if (typeof cargarTodosLosCasos==='function') setTimeout(()=>cargarTodosLosCasos(), 400);
        } else {
          if (typeof mostrarToast==='function') mostrarToast('Error: '+(r?.mensaje||''), 'error');
        }
      })
      .withFailureHandler(function(e){ if (typeof ocultarSpinner==='function') ocultarSpinner(); if (typeof mostrarToast==='function') mostrarToast('Error eliminando bug: '+(e?.message||e), 'error'); })
      .eliminarBug(url, bugId);
  }

  // Export globals
  window.mostrarPanelBugs = mostrarPanelBugs;
  window.ocultarPanelBugs = ocultarPanelBugs;
  window.cargarBugs = cargarBugs;
  window.renderizarTablaBugs = renderizarTablaBugs;
  window.cambiarEstadoBugUI = cambiarEstadoBugUI;
  window.eliminarBugUI = eliminarBugUI;
</script>
